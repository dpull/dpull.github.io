---
layout: post
title: Hero开发笔记-更新包版本管理
categories: [general]
tags: []
---

以前我们更新包版本管理做的很复杂，究其原因，是因为以前包合并后不能保证和目标文件二进制相同，仅能保证逻辑相同。举个例子，当前有一个1.1版本（称为A文件），新作了一个1.2版本（称为B文件），得到1.1到1.2的差异（称为C文件），A文件和C文件合并后，得到的1.2版本（称为D文件），以前我们是不会保证B文件和D文件，二进制相同，只保证游戏加载后逻辑相同。现在我们解决了这个问题，整个更新包的管理也变得简单起来了。

## 方案一 ##
CDN存放：

1. 完整的更新包的zip
1. 各版本间差异的zip，文件名命名为上一版本的md5

客户端计算当前包文件的md5，去请求md5.zip文件，有三个结果：

1. 文件不存在，客户端已经破损或者进行了大版本更新，下载完整更新包
1. 文件存在，且文件字节数大于0，有差异文件，合并差异并且重复这一个过程
1. 文件存在，且文件字节数等于0，已经是最新版本，可以进入游戏了

这个方案的缺点是：不能直观的知道当前服务器的版本文件

## 方案二 ##
CDN存放：

1. 完整的更新包的zip
1. 各版本间差异的zip，文件名随意
1. 一个查询网页，可以根据md5，算出更新包是什么

客户端计算当前包文件的md5，查询当前的更新包，有三个结果：
1. 未知md5，返回不支持，客户端已经破损或者进行了大版本更新，下载完整更新包
1. 存在更新包，重定向到下载文件，合并差异并且重复这一个过程（或者返回下载地址）
1. 不存在更新包，返回空，已经是最新版本，可以进入游戏了

这个方案的缺点是：我得找个人用世界上最好的语言php写这个查询网页。