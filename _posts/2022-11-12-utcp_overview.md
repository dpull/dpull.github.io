---
layout: post
title: Unreal传输层协议---概览
categories: [general]
tags: []
---



********************************************************************************************

utcp概览

udp介绍
tcp介绍
rudp介绍
解决建立连接慢
支持多路复用
支持自定义的拥堵算法降低延迟
链接迁移


utcp介绍



应用层三次握手，断线重连业务无感知。

支持多路复用，不同通道之间无影响。

可靠数据和不可靠数据有序执行，发送端知道哪些数据接收端没有执行。


发送端将数据标记为可靠包和不可可靠包进行发送。
接收端不可靠包按照发送顺序有序执行，允许不可靠包先于可靠包执行，但不能晚于可靠包执行。
发送端知道数据包的送达情况，可根据不同的需求选择是否重新发送。

基于这种规则，unreal将传输分为了三种类型：
可靠传输，不可靠传输，最终一致性的传输

可靠传输，不丢包，有序的送达
不可靠传输，保序执行，允许丢包，常用语不可靠rpc。
最终一致性传输，保序执行，允许丢包，丢包后发送方根据当前状态进行传输，常用语属性复制。


********************************************************************************************

计算机网络模型中传输层提供了TCP/UDP两种端对端的协议, 简单比较如下:

不要用这个, 自己的语言总结一下.

|              | TCP                                                | UDP                                                                           |  
| ------------ | -------------------------------------------------- | ----------------------------------------------------------------------------- |  
| 可靠性        | 与生俱来的。所有东西都以发送时的顺序进行传递和处理          | 没有。需要自定义实现，但是允许细粒度的可靠性                                         |
| 流量控制      | 如果数据包丢失，将自动降低传输速率                        | 没有。期望时，需要自定义流量和拥塞控制                                              |
| 内存需求      | 操作系统必须保存所有发送数据的副本，直到数据被确认          | 自定义实现必须确定什么样的数据需要保存,什么样的数据立即丢弃。内存管理在应用层              |  
| 路由器优先级   | 可能优先于UDP数据包                                   | 可能在TCP 数据包之前被丢奔                                                        |  

TCP可以满足大多数网络通信的要求, 对于TCP的流量控制带来的延迟问题, 有可靠UDP(rudp), 如QUIC, 提供了类TCP可靠性传输方案, 


在大多数情况下，选择使用哪个传输协议涉及以下问题: 游戏发送的每个
数据都需要被接收吗，需要以完全有序的方式进行处理吗? 如果答案是确
定的，那么应该考虑使用TCP。在回合制游戏中往往是这样的。输入的每
个数据都需要被其他主机接收并按序处理，所以TCP是最好的选择。

如果UDP是适合你的游戏的协议，那么你需要实现一个可靠系统。可靠
性的首要要求是，有能力知道数据包是否到达目的地。要做到这一点，你
需要创建某种形式的传递通知模块。该模块的任务是帮助高层依赖它的模
块将数据包发送到远程主机，然后通知这些模块数据是否到达。它自己不
实现重传，而是允许每个依赖模块仅仅重传它决定重传的数据。这是基于
UDP 的可靠传输所提供灵活性的主要来源，而TCP 并不能提供。


几乎每一个多人游戏都在某种程度上对网络可靠性有所要求，开发早期需
要做的一个重要决定是在TCP和UDP之间做出选择。是让你的游戏依赖于
TCP 已有的可靠系统，还是在UDP基础上开发自己的自定义的可靠系统?
为了回答这个问题，需要考虑每个传输层协议的好处和成本。

TCP的主要优点是，它提供了一个经得起时间考验、鲁棒的、稳定的可靠
性实现。没有额外的工程工作，保证所有的数据不仅能送达，而且能按序
送达。此外，它提供了复杂的拥塞控制功能，通过以不会阻塞中间路由器
的速率发送数据来限制数据包丢失。

TCP 的主要缺点是，它发送的所有东西必须被可靠发送并按序处理。在游
戏状态瞬息万变的多人游戏中，在三种不同的情景下;这种强制的、统一
的可靠传输可能会造成问题:

1，. 低优先级数据的丢失干扰高优先级数据的接收。在客户端-服务器模式
的第一人称射击游戏中，考虑两个玩家一次简短的数据交换。在客户端A
的玩家A和在客户端B 的玩家B互相攻击。突然一个其他来源的火箭在远
处发生了爆炸，服务器给客户端A 发送一个数据包来播放远处的爆炸声音。
之后不久，玩家B跳到玩家A的前面并射击，然后服务器发送一个包含该
信息的数据包给客户端A。由于网络流量的波动，第一个数据包丢失了，
但是包含玩家B动作的第二个数据包没有丢失。对于玩家A来说，爆炸声
音的优先级低，而敌人在他对面射击的优先级高。玩家A不关心这个丢失
的数据包，甚至从来没有发现这个爆炸也可以。但是，因为TCP按序处理
所有的数据包，所以当TCP 模块收到动作数据包时也不会发送给游戏。而
7.4 可靠性: TCP还是UDP | 203

是等到服务器重传低优先级的丢失数据包之后，才允许应用层处理高优先
级的动作数据包。那么，可以理解，这让玩家A非常肖丧。

2. 两个单独的可靠有序数据流相互干扰。甚至在不存在低优先级数据的
游戏中，即所有的数据必须可靠传输的情况下, TCP 的有序系统也会造成问
题。考虑刚才的情景，第一个数据包不是爆炸声音，而是包含给玩家和A的
聊天信息。聊天信息至关重要，所以必须以某种方式保证接收。此外，聊
天信息需要按序处理，因为乱序的聊天信息令人疑惑。但是，聊天信息只
“需要相对其他聊天信息是有序的就可以了。如果聊天数据包的丢失妨碍了
爆头数据包的处理，这不是玩家A所希望的。但是如果游戏使用TCP，就
可能会发生这种情况。

3. 过时游戏状态的重传。试想一下，玩家了穿越整个地图去射击玩家A。
她开始的时候在位置革0，在随后的5秒钟，跑向位置节100。服务器每秒
向玩家A发送5个数据包，每个数据包包含玩家了最新位置的z坐标。如
果服务器发现这些数据包中的任何一个入失了，那么都会重传。这意味着
当玩家B接近她的最终位置x*=100时，服务器可能还在重传过时的玩家也
接近z=0附近的状态数据。这导致玩家A看到的玩家了位置是非常过时的，
在收到玩家也靠近的信息之前就已经被射中了。这是玩家A不能接受的
用户体验。

除了执行强制的可靠性，使用TCP还有一些其他缺点。尽管拥塞控制有利
于防止去失数据包，但是并非所有的平台都是统一可配置的，有时可能

致你的游戏发送数据包的速度比你期望的要慢.Nagle算法在这里起了非常
不好的作用，因为它在将数据包发送出去之前可以延迟长达半秒。事实上，
使用TCP 作为传输层协议的游戏通常禁用Nagle算法以避免这个问题，虽
然同时放弃了它提供的减少数据包数量的优势。

最后,TCP为管理连接和跟踪所有可能被重传的数据分配了很多资源。这
些分配通常是由操作系统管理的，游戏需要时很难通过自定义内存管理器
的方式跟踪和路由。

另一方面,UDP没有提供TCP 所提供的内置可靠性和流量控制。但是，它
提供了一张空白画布，你可以根据游戏的需要绘制任何类型的自定义可靠
系统。你可以允许发送可靠的和不可靠的数据，或者分离的可靠有序数据
流的交错。也可以创建一个系统，在丢包时只发送最新消息，而不是重传
丢失的数据。可以自己管理内存，对数据如何分组成网络层数据包进行细
粒度的控制。

所有这些都增加了开发和测试的时间。自定义的系统自然不会像TCP 那样
成熟和没有错误。你可以使用第三方UDP 网络库来减少一些这方面的风险
204 | 第7章 延迟、抖动和可靠性

和成本，例如RakNet或Photon，尽管这样需要牺牲一些灵活性。此外，使
用UDP会增加数据包技失的风险，因为如前面所描述的，路由器可能被配
置为优先于弃UDP数据包。表7.1总结了这两个协议的区别。
