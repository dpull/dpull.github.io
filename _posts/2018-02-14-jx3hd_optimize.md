---
layout: post
title: 剑三重制版CPU优化总结
categories: [general]
tags: []
---

最近这半年的工作内容是优化客户端性能，其中主要内容是进行CPU优化，趁着春节假期，把做过的事情沉淀一下。

> 春节假期漫漫，想到一点写一点。。。。。。

CPU优化主要分成两个大块:

1. 充分利用多核
1. 提高渲染主线程的性能

优化工具:
intel vtune amplifier

## 充分利用多核（提纲）

存在问题
1. 每个模块有自己的一个后台加载线程，没有办法利用多核加载
1. 写法不规范，采用了Sleep轮询，占用了无用的时钟周期
1. 开启线程数过多，核心分散

解决办法
开发异步任务系统，任务按照优先级执行，同时可以执行多个任务。

带来问题
1. 机械硬盘多线程加载瓶颈
1. 核心数不足

## 提高渲染主线程的性能 （提纲）

1. 减少每帧的map查找操作
1. 调整数据结构降低cache miss
1. 使用多核的内存分配器减少内存分配的卡顿
1. 减少锁等待（使用share_mutex取代mutex）

### 如何减少卡顿

卡顿的原因有哪些？
1. CPU不足
1. 当前线程挂起（磁盘IO，内存分配，锁等待，调用显卡API）

CPU不足主要处理热点较高的函数，但当前线程挂起需要更多的分析，如vtune的[Frame API](https://software.intel.com/en-us/vtune-amplifier-help-frame-api)

